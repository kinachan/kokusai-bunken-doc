

# 設計書 - 利用者認証機能

本頁では学会利用者が本Appを利用可能にするまでの認証機能を定義する

## フロー概要


```mermaid

sequenceDiagram
autonumber

actor user as 学会利用者
actor admin as 学会管理者
participant server as サーバー

admin->>+server: 学会利用者の申請データ登録
server->>+user: メール送信
  note right of server: メールには専用のIDが付与されたURLと<br/>手続き用コードを送付
user->>+user: メールを開き、URLを開く
user->>+server: ページのURLにアクセスし、手続き用のコードを入力
server->>+user: 認証コードを送信
  note right of server: 認証コードのみを送付
user->>+server: 認証コードを入力
server->>+user: フォーム表示
```

本頁では認証処理のみ抜粋して記載する。
そのため、学会管理者の申請データ登録・フォーム表示以降の処理については割愛とする

### 1. 学会利用者の申請データ登録

学会管理者が学会利用者の情報を入力し、認証可能な状態へと登録を実施
※本処理の前提となるが、本頁からは外れる為詳細については割愛

詳細は[基本設計書-交通費申請データ登録](基本設計書-交通費申請データ登録)を参照


### 2. 手続き用メール送信

学会利用者（交通費の申請者）へ向けてメールを送信する。

#### 手続き用メール送信-詳細フロー

```mermaid
flowchart TD
  Start(スタート) --> sendMail{メール送信実行}
  subgraph サーバー処理
    sendMail --> |送信成功|successMsg[メッセージ表示]
    sendMail --> |送信失敗|errMsg[エラーメッセージ表示]
  end
  successMsg --> fin(終了)
  errMsg --> fin(終了)

  click sendMail href "#手続き用メール送信-メール送信実行5"
  click successMsg href "#手続き用メール送信-メッセージ表示5"
  click errMsg href "#手続き用メール送信-エラーメッセージ表示5"

```

##### 手続き用メール送信-メール送信実行

メール送信を実行する、送信する内容については以下の項目となる
また、メール送信に伴う設定情報については[環境設定項目](基本設計書-環境設定#アプリケーション環境設定情報3)を参照

| 名称 | 設定値 | 備考欄 |
| ---- | ---- | ---- |
| From | 学会利用者のメールアドレス |  |
| 件名 | 交通費申請の手続きコードが発行されました。 |  |
| 本文 | {name}<br/>以下のURLをクリックして、交通費の入力をお願いします。<br/>画面が表示されたら手続き用のコードを入力してください。<br/>手続き用コード：{processCode}<br/><br/>[URL形式で ドメイン+/travel-cost/{applicantId}<br/> | パラメーターについては下記を参照 |

また、メール送信に伴うパラメーターは以下の通り

| 名称 | 物理名 | 説明 |
| ---- | ---- | ---- |
| 氏名 | name | 学会利用者の氏名、前処理の入力情報を使用 |
| 手続きコード | processCode | 自動採番の6桁の数字 |
| 申請ID | applicantId | 前処理にて発行されたユニークID |

本処理の送信結果（送信成功フラグ）を画面の処理へ返却する

- true
  - [手続き用メール送信-メッセージ表示](#手続き用メール送信-メッセージ表示5)へ進む
- false
  - [手続き用メール送信-エラーメッセージ表示](#手続き用メール送信-エラーメッセージ表示5)へ進む


##### 手続き用メール送信-メッセージ表示

メールが問題なく送信された場合は画面上に`送信が完了しました`とメッセージを表示する。

> 補足事項
> 本メールが送信された段階では特に有効期限は設けておらず、学会利用者がURLをクリックしない場合でも有効となる
> ただ、デバイスの切り替え（PCの買替・機種変更）などでメールの紛失が予想されるため
> その際は学会管理者が同条件でメールの再送信を可能にする、この操作を行った場合は手続きコードの更新のみとする

##### 手続き用メール送信-エラーメッセージ表示

送信が失敗した場合、`エラーが発生しました`と表示する。

### 3. URL表示

本処理にてURLの妥当性チェックを実施する

#### URL表示-詳細フロー

```mermaid
flowchart TD

start(スタート)--> showUrl[URL遷移]
showUrl --> ApiCall{API送信}
ApiCall --> |エラー発生| errMsg[エラーメッセージ]
errMsg --> fin(終了)
subgraph サーバー処理
  ApiCall --> |正常| exists[データ存在チェック]
  exists --> returnData[データ返却]
end
returnData --> dataCheck{データチェック}
dataCheck --> |false| fin
dataCheck --> |true| showView(画面表示)

click showUrl href "#URL表示-URL遷移5"
click ApiCall href "#URL表示-API送信5"
click errMsg href "#URL表示-エラーメッセージ5"
click exists href "#URL表示-データ存在チェック5"
click returnData href "#URL表示-データ返却5"
click dataCheck href "#URL表示-データチェック5"
click showView href "#URL表示-画面表示5"

```

##### URL表示-URL遷移

交通費申請者がメールに記載されたURLをクリックし、画面を表示する
URLには申請IDが付与されているが、安全性のために後続の処理にてURLの妥当性を確認する

##### URL表示-API送信

URLに付与されたパラメーターを元にサーバー側へリクエストを送信する

| URL | HTTPメソッド |
| ---- | ---- |
| `/api/code/init` | GET |

**リクエスト情報**
| キー名称 | 値 |
| ---- | ---- |
| id | クエリパラメータに付与されたID |


その他のHttpヘッダー情報は[API共通機能](基本設計書-API共通機能#リクエスト情報送信4)を参照

##### URL表示-データ存在チェック

前処理で送信したリクエスト情報を元にデータベースへ存在確認を実施する
Firebase DataStoreへとアクセスを実施する

- データが存在している場合
  - `true`を返却する
- データが存在していない場合
  - `false`を返却する

##### URL表示-データ返却

前処理の判定結果をレスポンスとして返却する

##### URL表示-データチェック

レスポンスデータを元に下記の処理分岐を実施する

- `true`の場合
  - [URL表示-画面表示](#URL表示-画面表示5)へと進む
- `false`の場合
  - [URL表示-エラーメッセージ](#URL表示-エラーメッセージ5)へと進む

##### URL表示-画面表示
 
画面が正常に表示され、入力可能な状態となる

##### URL表示-エラーメッセージ

エラー画面へと遷移する

### 4. 手続き用コード入力

学会利用者はメールにて記載された手続き用コードを入力する。
正しい値を入力すると次工程へと進む

#### 手続き用コード入力-詳細フロー

```mermaid
flowchart TD
  Start(スタート) --> inputCode[ユーザー入力]
  inputCode --> validCheck{バリデーションチェック}

  validCheck --> |エラー| inputCode
  validCheck --> |エラーなし| exists{手続き用コード一致確認}
  exists ---> |一致| fin(次の処理へ)
  exists --> |不一致| errMsg[エラーメッセージ表示]
  errMsg --> inputCode
  
  click inputCode href "#手続き用コード入力-ユーザー入力5"
  click validCheck href "#手続き用コード入力-バリデーションチェック5"
  click exists href "#手続き用コード入力-手続き用コード一致確認5"
  click errMsg href "#手続き用コード入力-エラーメッセージ表示5"

```

##### 手続き用コード入力-ユーザー入力

ユーザーがメールに送付された手続き用コードを入力し、送信ボタンを押下する
(入力中でもバリデーションチェックは実施される)

##### 手続き用コード入力-バリデーションチェック

以下の条件で入力値の妥当性チェックを実施する
全て条件を合格してることとする

| 条件 |
| ---- |
| 入力値が存在している |
| 6桁の入力値である |
| 半角数字である |

- 条件が全て満たしている
  - [手続き用コード入力-手続き用コード一致確認](#手続き用コード入力-手続き用コード一致確認5)へと進む
- いずれかの条件に満たしていない
  - [手続き用コード入力-ユーザー入力](#手続き用コード入力-ユーザー入力5)へと進む


##### 手続き用コード入力-手続き用コード一致確認

データベースに登録されている手続き用コードの確認を実施するために、サーバー側へリクエストを送信する

| URL | HTTPメソッド |
| ---- | ---- |
| `/api/code/check` | POST |

**リクエスト情報**
| キー名称 | 値 |
| ---- | ---- |
| id | クエリパラメータに付与されたID |
| processCode | 画面上で入力された手続きコード |

その他のHttpヘッダー情報は[API共通機能](基本設計書-API共通機能#リクエスト情報送信4)を参照

※APIの処理については[API共通機能](基本設計書-API共通機能)を参照

前処理で送信したprocessCodeを元にデータベースへ存在確認を実施する
Firebase DataStoreへとアクセスを実施する

- `ProcessCode`が存在している場合
  - [5. 認証コードを送信](#5.認証コードを送信3)へと進む
  - **※この際はクライアントへレスポンスは返さずに、次の工程へと進める**
- `ProcessCode`が存在していない場合
  - [手続き用コード入力-エラーメッセージ表示](#手続き用コード入力-エラーメッセージ表示5)へと進む

##### 手続き用コード入力-エラーメッセージ表示

以下のエラーメッセージを表示する

|エラーメッセージ|
|---|
|手続き用コードが古いか、一致しませんでした。|

### 5. 認証コードを送信

URLにて発行されたトークン、手続き用コードが一致している場合は本人と認識するが
安全性を考慮し、この段階で認証コード付きのメールを学会利用者へ再度送信する。

#### 認証コード送信-詳細フロー

```mermaid
flowchart TD
  subgraph サーバー処理
    Start(スタート) --> setupParam[メールパラメータ設定]
    setupParam --> sendMail[メール送信]
  end

  sendMail --> returnValCheck{戻り値チェック}
  returnValCheck --> |エラーメッセージなし|viewChange(画面表示切替)
  returnValCheck --> |エラーメッセージあり|errMsg(エラーメッセージ)

  click setupParam href "#認証コード送信-メールパラメータ設定5"
  click sendMail href "#認証コード送信-メール送信5"
  click returnValCheck href "#認証コード送信-戻り値チェック5"
  click viewChange href "#認証コード送信-画面表示切替5"
  click errMsg href "#認証コード送信-エラーメッセージ5"
```

##### 認証コード送信-メールパラメータ設定

認証コードを設定したメールを送信する

| 名称 | 設定値 | 備考欄 |
| ---- | ---- | ---- |
| From | 学会利用者のメールアドレス |  |
| 件名 | 交通費申請の認証コードが発行されました。 |  |
| 本文 | {name}さま<br/>以下の認証コードを画面に入力してください。<br/>認証コード：{secretCode}<br/>有効期限は{expireDate}までとなります。 | パラメーターについては下記を参照 |

また、メール送信に伴うパラメーターは以下の通り

| 名称 | 物理名 | 説明 |
| ---- | ---- | ---- |
| 氏名 | name | 学会利用者の氏名、前処理の入力情報を使用 |
| 認証コード | secretCode | 6桁の数字、自動採番 |
| 有効期限 | expireDate | 本日の日付時刻 + 24時間 |

##### 認証コード送信-メール送信

前処理にて設定したパラメータを元にメールの送信を実行する

また、メール送信に伴う設定情報については[環境設定項目](基本設計書-環境設定#アプリケーション環境設定情報3)を参照

送信結果をレスポンス結果として返す

##### 認証コード送信-戻り値チェック

前処理のレスポンス結果を見て判定を実施する
- `true` の場合
  - [認証コード送信-画面表示切替](#認証コード送信-画面表示切替5)へ進む
- `false` の場合
  - [認証コード送信-エラーメッセージ](#認証コード送信-エラーメッセージ5)へ進む

##### 認証コード送信-画面表示切替

画面が切り替わり、認証コードが入力可能な画面へと切り替わる

##### 認証コード送信-エラーメッセージ

以下のエラーメッセージを表示する

|エラーメッセージ|
|---|
|メール送信に失敗しました。|

> この場合はメールおよび認証コードが登録されていないので、再度手続きを可能とする
> その際は同一の手続き用コードを使用する

### 6. 認証コード入力

画面にメールに送付された認証コードを入力し、妥当性チェックを実施する

#### 認証コード入力-詳細フロー

```mermaid
flowchart TD
  start(スタート) --> ApiCall{API送信}
  subgraph サーバー処理
    ApiCall --> validCode[認証コードチェック]
    validCode --> returnValue[戻り値返却]
  end
  returnValue --> returnValCheck{戻り値チェック}
  returnValCheck --> |true|fin(次の処理へ)
  returnValCheck --> |false|Err(エラーメッセージ表示)
  Err--> |再度入力可能|start

  click ApiCall href "#認証コード入力-API送信5"
  click validCode href "#認証コード入力-認証コードチェック5"
  click returnValue　href "#認証コード入力-戻り値返却5"
  click returnValCheck href "#認証コード入力-戻り値チェック5"
  click Err href "#認証コード入力-エラーメッセージ表示5"

```

##### 認証コード入力-API送信

URLに付与されたパラメーターを元にサーバー側へリクエストを送信する

| URL | HTTPメソッド |
| ---- | ---- |
| `/api/code/verify` | POST |

**リクエスト情報**
| キー名称 | 値 |
| ---- | ---- |
| id | クエリパラメータに付与されたID |
| secretCode | 画面上で入力された認証コード |

その他のHttpヘッダー情報は[API共通機能](基本設計書-API共通機能#リクエスト情報送信4)を参照
※APIの処理については[API共通機能](基本設計書-API共通機能)を参照

　
##### 認証コード入力-認証コードチェック

前処理で送信した`id`, `secretCode`を元にデータベースへ存在確認を実施する
Firebase DataStoreへとアクセスを実施する。

- 一致しているかつ、送信日が有効期限内である場合
  - `交通費申請データ`を返却する
- 上記の条件を満たしていない場合
  - `null`を返却する

##### 認証コード入力-戻り値返却

前処理にて返した判定結果をレスポンス情報として返却する。

##### 認証コード入力-戻り値チェック

前処理のレスポンス結果を見て判定を実施する
- `交通費申請データ`が存在している場合
  - [認証コード入力7. フォーム表示](#7.フォーム表示3)へ進む
- `null` の場合
  - [認証コード入力-エラーメッセージ表示](#認証コード入力-エラーメッセージ表示5)へ進む


##### 認証コード入力-エラーメッセージ表示

以下のエラーメッセージを表示する
**こちらは有効期限切れ・コードの不一致問わず全て該当のエラーを返却する。(セキュリティリスクが高まる為)**

|エラーメッセージ|
|---|
|エラーが発生しました。|


### 7. フォーム表示

画面上にフォームを表示し、交通費申請を可能とする
※詳細は[基本設計書-交通費申請](基本設計書-交通費申請)を参照

